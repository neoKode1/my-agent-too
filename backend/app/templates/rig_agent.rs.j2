//! {{ project_name }} â€” {{ template_name }}
//!
//! {{ template_description }}
//!
//! Generated by +12 Monkeys â€¢ Framework: Rig (Rust)

use rig::providers::anthropic;
use rig::agent::Agent;
use rig::completion::Prompt;
use std::env;

// ---------------------------------------------------------------------------
// Agent Definitions
// ---------------------------------------------------------------------------
{% for agent in agents %}
/// {{ agent.role }} â€” {{ agent.goal }}
async fn {{ agent.role }}_step(client: &anthropic::Client, input: &str{% if not loop.first %}, context: &str{% endif %}) -> Result<String, Box<dyn std::error::Error>> {
    let agent = client
        .agent(env::var("LLM_MODEL").unwrap_or_else(|_| "claude-sonnet-4-20250514".into()).as_str())
        .preamble("You are the {{ agent.role }} agent. Your goal: {{ agent.goal }}")
        .build();

    let prompt = format!(
        "Input: {input}\n{% if not loop.first %}Previous step context: {context}\n{% endif %}Provide your output:"
    );
    let response = agent.prompt(&prompt).await?;
    Ok(response)
}

{% endfor %}
// ---------------------------------------------------------------------------
// Pipeline
// ---------------------------------------------------------------------------
async fn run_pipeline(input: &str) -> Result<String, Box<dyn std::error::Error>> {
    dotenv::dotenv().ok();
    let api_key = env::var("ANTHROPIC_API_KEY")
        .expect("ANTHROPIC_API_KEY must be set in .env");

    let client = anthropic::Client::new(&api_key);

    println!("\nðŸš€ Starting {{ project_name }} pipeline...\n");

    let mut current_output = input.to_string();
    {% for agent in agents %}

    // Step {{ loop.index }}: {{ agent.role }}
    println!("  â³ Running {{ agent.role }}...");
    current_output = {{ agent.role }}_step(&client, input{% if not loop.first %}, &current_output{% endif %}).await?;
    println!("  âœ… {{ agent.role }} complete");
    {% endfor %}

    Ok(current_output)
}

// ---------------------------------------------------------------------------
// Entry Point
// ---------------------------------------------------------------------------
#[tokio::main]
async fn main() -> Result<(), Box<dyn std::error::Error>> {
    let args: Vec<String> = env::args().skip(1).collect();
    let user_input = if args.is_empty() {
        "Hello, I need help.".to_string()
    } else {
        args.join(" ")
    };

    let result = run_pipeline(&user_input).await?;
    println!("\nâœ… Result:\n{result}");
    Ok(())
}

