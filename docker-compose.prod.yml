# +12 Monkeys â€” Production Docker Compose
# Usage:
#   cp .env.production.example .env.production
#   # fill in real values in .env.production
#   docker compose -f docker-compose.prod.yml --env-file .env.production up -d

version: "3.9"

services:
  # ---------- MongoDB ----------
  mongo:
    image: mongo:7
    restart: unless-stopped
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 10s
    # Not exposed to host in production; only accessible via internal network
    networks:
      - internal

  # ---------- NANDA Index (registry) ----------
  nanda:
    build:
      context: ./nanda-index
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      PORT: "6900"
      MONGODB_URI: "${MONGODB_URI:-mongodb://mongo:27017}"
      MONGODB_DB: "${MONGODB_DB:-twelve_monkeys}"
      ENABLE_FEDERATION: "${ENABLE_FEDERATION:-false}"
    depends_on:
      mongo:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:6900/health')"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - internal

  # ---------- +12 Monkeys Backend (FastAPI) ----------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    environment:
      ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY}"
      NANDA_URL: "http://nanda:6900"
      CORS_ORIGINS: "${CORS_ORIGINS:-*}"
      DEBUG: "${DEBUG:-false}"
      LLM_MODEL: "${LLM_MODEL:-claude-sonnet-4-20250514}"
      SESSION_TTL_MINUTES: "${SESSION_TTL_MINUTES:-1440}"
      SESSION_MAX_COUNT: "${SESSION_MAX_COUNT:-500}"
    depends_on:
      nanda:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - internal
      - public

networks:
  internal:
    driver: bridge
  public:
    driver: bridge

volumes:
  mongo_data:

