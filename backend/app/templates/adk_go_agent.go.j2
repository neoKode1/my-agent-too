// {{ project_name }} â€” {{ template_name }}
//
// {{ template_description }}
//
// Generated by +12 Monkeys â€¢ Framework: Google ADK-Go

package main

import (
	"context"
	"fmt"
	"log"
	"os"
	"strings"

	"github.com/google/adk-go/pkg/agents"
	"github.com/google/adk-go/pkg/models"
	"github.com/joho/godotenv"
)

// ---------------------------------------------------------------------------
// Agent Definitions
// ---------------------------------------------------------------------------
{% for agent in agents %}
// {{ agent.role }}Agent â€” {{ agent.goal }}
func {{ agent.role }}Agent() *agents.Agent {
	return agents.NewAgent(
		"{{ agent.role }}",
		&agents.AgentConfig{
			Model:       modelName(),
			Instruction: "You are the {{ agent.role }} agent. Your goal: {{ agent.goal }}",
		},
	)
}

{% endfor %}
// ---------------------------------------------------------------------------
// Pipeline
// ---------------------------------------------------------------------------
func runPipeline(ctx context.Context, userInput string) (string, error) {
	fmt.Println("\nðŸš€ Starting {{ project_name }} pipeline...\n")

	currentOutput := userInput
	{% for agent in agents %}

	// Step {{ loop.index }}: {{ agent.role }}
	fmt.Println("  â³ Running {{ agent.role }}...")
	{
		agent := {{ agent.role }}Agent()
		{% if loop.first %}
		prompt := fmt.Sprintf("Input: %s\nProvide your output:", userInput)
		{% else %}
		prompt := fmt.Sprintf("Input: %s\nPrevious step context: %s\nProvide your output:", userInput, currentOutput)
		{% endif %}
		resp, err := agent.Generate(ctx, prompt, nil)
		if err != nil {
			return "", fmt.Errorf("{{ agent.role }} failed: %w", err)
		}
		currentOutput = resp.Text()
	}
	fmt.Println("  âœ… {{ agent.role }} complete")
	{% endfor %}

	return currentOutput, nil
}

// ---------------------------------------------------------------------------
// Helpers
// ---------------------------------------------------------------------------
func modelName() string {
	if m := os.Getenv("LLM_MODEL"); m != "" {
		return m
	}
	return "claude-sonnet-4-20250514"
}

// ---------------------------------------------------------------------------
// Entry Point
// ---------------------------------------------------------------------------
func main() {
	_ = godotenv.Load()

	if os.Getenv("ANTHROPIC_API_KEY") == "" {
		log.Fatal("ANTHROPIC_API_KEY must be set in .env")
	}

	args := os.Args[1:]
	userInput := "Hello, I need help."
	if len(args) > 0 {
		userInput = strings.Join(args, " ")
	}

	ctx := context.Background()
	result, err := runPipeline(ctx, userInput)
	if err != nil {
		log.Fatalf("Pipeline error: %v", err)
	}
	fmt.Printf("\nâœ… Result:\n%s\n", result)
}

